# Flutter 项目打包APK的完整工作流配置
# 适配github actions自动打包release版APK
name: Flutter Build APK

# 触发条件：提交代码到main分支、手动触发都可以
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: # 手动触发开关，推荐保留

jobs:
  build_apk:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. 拉取你的项目代码
      - uses: actions/checkout@v4

      # 2. 安装Flutter环境（核心！替代原来的dart环境）
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.x' # 稳定版flutter，适配绝大多数项目
          channel: 'stable'          # 稳定渠道

      # 3. 刷新flutter环境
      - name: Flutter Doctor
        run: flutter doctor -v

      # 4. 安装flutter项目依赖（核心修改！原来是dart pub get，改成这个）
      - name: Install dependencies
        run: flutter pub get

      # 5. 清理项目缓存（避免打包缓存报错）
      - name: Clean project
        run: flutter clean

      # 6. 构建Flutter Release正式版APK （最关键的打包步骤）
      - name: Build Release APK
        run: flutter build apk --release --split-per-abi

      # 7. 上传打包好的APK文件到github，打包完成后可直接下载
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: build/app/outputs/flutter-apk/
